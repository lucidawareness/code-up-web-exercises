<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Weather Map</title>
    <!-- Mapbox JS -->

    <script src='https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.css' rel='stylesheet'/>

    <!--Bootstrap CDN-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css"
          integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn" crossorigin="anonymous">
    <style>
        #map {
            width: 100vw;
            height: 50vh;
        }
    </style>
</head>
<body>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.min.js"></script>
<link rel="stylesheet"
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css"
      type="text/css">
<nav class="bg-primary container-fluid">
    <div class="row align-items-baseline justify-content-between">
        <h2 class="py-2 pl-2 text-white">Weather App</h2>
        <p class="pr-2 pt-2 text-white font-weight-bold">Current City: Dallas TX </p>
    </div>
</nav>
<header class="container-fluid">
    <div class="row align-items-baseline">
        <p class="mt-4 ml-4">Place</p>
        <div class="ml-3 geocoder" type="search" id="geocoder"></div>
        <button type="submit" class="btn btn-primary ml-3" id="place-search">Find</button>
    </div>
    <div class="row align-items-baseline justify-content-center card-container">

    </div>
    <div class="row">
        <div id='map' class="mt-3 mx-3"></div>
    </div>
</header>


<!--Bootstrap CDN-->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-fQybjgWLrvvRgtW6bFlB7jaZrFsaBXjsOMm/tB9LTS58ONXgqbR9W8oWht/amnpF"
        crossorigin="anonymous"></script>
<!--CDN Jquery File-->
<script src="https://code.jquery.com/jquery-2.2.4.min.js"
        integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
<script src="js/keys.js"></script>
<script>
	(function () {
		'use strict'
		//Mapbox map created
		mapboxgl.accessToken = KEY_API_MAPBOX;
		let map = new mapboxgl.Map({
			container: 'map',
			style: 'mapbox://styles/mapbox/streets-v11',
			zoom: 10,
			center: [
				-96.7969,
				32.7763
			]
		});

		//Creates map box search box
		const geocoder = new MapboxGeocoder({
			accessToken: mapboxgl.accessToken,
			mapboxgl: mapboxgl
		});
		//Adds map box search to html
		document.getElementById('geocoder').appendChild(geocoder.onAdd(map));

		function onLoadWeatherData() {
			map.on('load', function (e) {
				let center = map.getCenter();
				sendQueryToOpenWeather(center);
			})
		}

		onLoadWeatherData();

		//Gets lnglat from map after zoom ends to pass to weather api
		function getLnglatAfterMapZoomEnds() {
			map.on('zoomend', function (e) {
				let center = map.getCenter();
				console.log(center.lat)
				console.log(center.lng)
				sendQueryToOpenWeather(center);
			})
		}

		getLnglatAfterMapZoomEnds()


		//On submit gets input value from search box and calls sendQueryToOpen weather with input value as a parameter
		// function getSearchQuery() {
		// 	$('#place-search').click(function () {
		// 		let inputValue = $('#search-city').val();
		// 		sendQueryToOpenWeather(inputValue);
		// 	});
		// }

		// getSearchQuery()

		//Sends center of map to open weather api with value input as param
		function sendQueryToOpenWeather(center) {
			$.get(`http://api.openweathermap.org/data/2.5/onecall?lat=${center.lat}&lon=${center.lng}&exclude=hourly,minutely,alerts&units=imperial&appid=${OPEN_WEATHER_APPID}`, {}).done(function (weatherData) {
				// populateWeatherCards(weatherData);
				map.setCenter(center);
				let unix_timestamp = weatherData.current.dt;
				let date = new Date(unix_timestamp * 1000)
				// console.log(date);

				let dailyArr = weatherData.daily;
				dailyArr.forEach(function (day, index) {
					if (index > 4) {
						return
					}
					console.log(day)
					unix_timestamp = day.dt;
					date = new Date(unix_timestamp * 1000);
					let year = date.getFullYear();
					let month = date.getMonth();
					let dayNum = date.getDate();
					// let
					// console.log(day.temp.min)
					let minTemp = day.temp.min;
					console.log(minTemp);
					let maxTemp = day.temp.max;
					console.log(maxTemp);
					let icon = day.weather[0].icon;
					console.log(icon);
					let description = day.weather[0].description;
					console.log(description);
					let wind = day.wind_speed;
					console.log(wind);
					let humidity = day.humidity;
					console.log(humidity);
					// let pressure =
					// console.table(day.weather[0])
					// console.log(day.weather[0].description);
					// console.log(`${year}-${month}-${dayNum}`)
					// console.log(`Day:${index}, ${date} `)

				})

			});
		}

		// function populateWeatherCards(weatherData) {
		// 	console.log(weatherData);
		// 	weatherData.forEach(function (restaurant, index) {
		// 		let restaurantNum = index + 1;
		// 		$('#').append(`
		// <div className="card mt-4 ml-3 col-10 col-lg-2 px-0" style="width: 18rem;">
		// 	<div className="card-header text-center">
		// 		Date
		// 	</div>
		// 	<ul className="list-group list-group-flush">
		// 		<li className="list-group-item text-center">img</li>
		// 		<li className="list-group-item">
		// 			<p>Description: <span className="font-weight-bold">Overcast clouds</span></p>
		// 			<p className="mb-0">Humidity: <span className="font-weight-bold">71%</span></p>
		// 		</li>
		// 		<li className="list-group-item">Wind: <span className="font-weight-bold">5.84</span></li>
		// 		<li className="list-group-item">Pressure: <span className="font-weight-bold">1015</span></li>
		// 	</ul>
		// </div>
		// 	`);
		// 	})
		// }

		//Function to fly to given data coords
		// function flyTo(data) {
		// 	map.flyTo({
		// 		center: [data.coord.lon, data.coord.lat],
		// 		zoom: 11,
		// 		speed: 1.5,
		// 		curve: 1,
		// 		easing(t) {
		// 			return t;
		// 		}
		// 	});
		// }

		//On click of map point, get coords and send to open weather api for weather info of location clicked on
		function latLonOnClick() {
			map.on('click', function (e) {
				console.log(e.lngLat)
				// Create a new marker.
				const marker = new mapboxgl.Marker({
					draggable: true
				})
					.setLngLat(e.lngLat)
					.addTo(map);
				map.setCenter(e.lngLat);
				afterDropCoords(marker);
				let markerCenter = map.getCenter();
				sendQueryToOpenWeather(markerCenter)
			})
		}

		latLonOnClick()

		//If marker is dragged call open weather api with updated location of marker
		function afterDropCoords(marker) {
			marker.on('dragend', function () {
				const lngLat = marker.getLngLat();
				map.setCenter(lngLat);
				console.log(lngLat);
				sendQueryToOpenWeather(lngLat)
			})
		}

		//Takes lnglat attempt to return city name (not complete)
		// function reverseGeocode(e) {
		// 	$.get(`https://api.mapbox.com/geocoding/v5/mapbox.places/${e.lngLat.lng},${e.lngLat.lat}.json?access_token=${KEY_API_MAPBOX}`, {}).done(function (data) {
		// 		console.log(data.features);
		// 	})
		// }

		// Todo: Add feature to get weather details after submit from input box

		// Todo: Add feature to get weather details after click on point of map

		//Todo: Add feature that populates cards with weather details 5-day forecast and top right city name

	})();
</script>
</body>
</html>